#!/bin/bash
# Enhanced postBuild for EOPF-Zarr driver in MyBinder

set -euo pipefail

echo "üîß Setting up EOPF-Zarr driver environment for MyBinder..."

# Create directories
mkdir -p /home/jovyan/eopf-zarr/drivers
mkdir -p /home/jovyan/eopf-zarr/build

# Set environment variables permanently
echo 'export GDAL_DRIVER_PATH="/home/jovyan/eopf-zarr/drivers"' >> ~/.bashrc
echo 'export GDAL_DATA="$CONDA_PREFIX/share/gdal"' >> ~/.bashrc
echo 'export PROJ_LIB="$CONDA_PREFIX/share/proj"' >> ~/.bashrc

# Also set for current session
export GDAL_DRIVER_PATH="/home/jovyan/eopf-zarr/drivers"
export GDAL_DATA="$CONDA_PREFIX/share/gdal"
export PROJ_LIB="$CONDA_PREFIX/share/proj"

echo "üìÅ Environment variables set:"
echo "  GDAL_DRIVER_PATH: $GDAL_DRIVER_PATH"
echo "  GDAL_DATA: $GDAL_DATA"
echo "  PROJ_LIB: $PROJ_LIB"

# Build EOPF-Zarr driver with better error handling
echo "üî® Building EOPF-Zarr driver..."

cd /home/jovyan/eopf-zarr

# Clone source with error handling
echo "üì• Cloning EOPF-Zarr source..."
if git clone https://github.com/EOPF-Sample-Service/GDAL-ZARR-EOPF.git source; then
    echo "‚úÖ Source cloned successfully"
    
    cd build
    
    # Configure build
    echo "‚öôÔ∏è Configuring build with CMake..."
    if cmake ../source \
        -DCMAKE_BUILD_TYPE=Release \
        -DGDAL_CONFIG="$CONDA_PREFIX/bin/gdal-config" \
        -DCMAKE_INSTALL_PREFIX=/home/jovyan/eopf-zarr; then
        
        echo "‚úÖ CMake configuration successful"
        
        # Build the driver
        echo "üî® Building driver..."
        if make -j2; then
            echo "‚úÖ Build successful!"
            
            # Copy driver to drivers directory
            if [ -f "gdal_EOPFZarr.so" ]; then
                cp gdal_EOPFZarr.so ../drivers/
                chmod 755 ../drivers/gdal_EOPFZarr.so
                echo "‚úÖ EOPF-Zarr driver installed successfully!"
                echo "üìÅ Driver location: /home/jovyan/eopf-zarr/drivers/gdal_EOPFZarr.so"
                
                # Verify the driver file
                ls -la ../drivers/
            else
                echo "‚ùå Driver file not found after build"
                ls -la .
            fi
        else
            echo "‚ùå Build failed"
        fi
    else
        echo "‚ùå CMake configuration failed"
    fi
else
    echo "‚ùå Failed to clone source repository"
fi

# Create comprehensive test notebook
cat > /home/jovyan/test_eopf_driver.ipynb << 'EOF'
{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# EOPF-Zarr Driver Test - MyBinder Edition\n",
    "\n",
    "This notebook validates the EOPF-Zarr GDAL driver installation in MyBinder."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "import os\n",
    "import sys\n",
    "print(f'üêç Python: {sys.version}')\n",
    "print(f'üìÅ Working directory: {os.getcwd()}')\n",
    "print(f'üè† Home directory: {os.path.expanduser(\"~\")}')\n",
    "\n",
    "# Set environment variables for this session\n",
    "os.environ['GDAL_DRIVER_PATH'] = '/home/jovyan/eopf-zarr/drivers'\n",
    "os.environ['GDAL_DATA'] = os.path.join(os.environ.get('CONDA_PREFIX', ''), 'share', 'gdal')\n",
    "os.environ['PROJ_LIB'] = os.path.join(os.environ.get('CONDA_PREFIX', ''), 'share', 'proj')\n",
    "\n",
    "print(f'\\nüîß Environment Variables:')\n",
    "print(f'  GDAL_DRIVER_PATH: {os.environ.get(\"GDAL_DRIVER_PATH\")}')\n",
    "print(f'  GDAL_DATA: {os.environ.get(\"GDAL_DATA\")}')\n",
    "print(f'  PROJ_LIB: {os.environ.get(\"PROJ_LIB\")}')\n",
    "print(f'  CONDA_PREFIX: {os.environ.get(\"CONDA_PREFIX\")}')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Check if driver file exists\n",
    "import os\n",
    "driver_file = '/home/jovyan/eopf-zarr/drivers/gdal_EOPFZarr.so'\n",
    "print(f'üìÅ Checking driver file: {driver_file}')\n",
    "\n",
    "if os.path.exists(driver_file):\n",
    "    stat = os.stat(driver_file)\n",
    "    print(f'‚úÖ Driver file exists!')\n",
    "    print(f'   Size: {stat.st_size} bytes')\n",
    "    print(f'   Permissions: {oct(stat.st_mode)}')\n",
    "else:\n",
    "    print(f'‚ùå Driver file not found')\n",
    "    print(f'üìÇ Contents of eopf-zarr directory:')\n",
    "    eopf_dir = '/home/jovyan/eopf-zarr'\n",
    "    if os.path.exists(eopf_dir):\n",
    "        for root, dirs, files in os.walk(eopf_dir):\n",
    "            level = root.replace(eopf_dir, '').count(os.sep)\n",
    "            indent = ' ' * 2 * level\n",
    "            print(f'{indent}{os.path.basename(root)}/')\n",
    "            subindent = ' ' * 2 * (level + 1)\n",
    "            for file in files[:10]:  # Limit to first 10 files\n",
    "                print(f'{subindent}{file}')\n",
    "    else:\n",
    "        print(f'   Directory does not exist')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Test GDAL import and basic functionality\n",
    "try:\n",
    "    from osgeo import gdal\n",
    "    print(f'‚úÖ GDAL imported successfully')\n",
    "    print(f'üì¶ GDAL Version: {gdal.VersionInfo()}')\n",
    "    \n",
    "    # Register all drivers\n",
    "    gdal.AllRegister()\n",
    "    driver_count = gdal.GetDriverCount()\n",
    "    print(f'üìä Total GDAL drivers: {driver_count}')\n",
    "    \n",
    "except ImportError as e:\n",
    "    print(f'‚ùå Failed to import GDAL: {e}')\n",
    "except Exception as e:\n",
    "    print(f'‚ùå GDAL error: {e}')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Test EOPF-Zarr driver specifically\n",
    "try:\n",
    "    from osgeo import gdal\n",
    "    \n",
    "    # Try to get EOPF-Zarr driver by name\n",
    "    eopf_driver = gdal.GetDriverByName('EOPFZARR')\n",
    "    \n",
    "    if eopf_driver:\n",
    "        print(f'üéâ SUCCESS! EOPF-Zarr driver found!')\n",
    "        print(f'   Driver name: {eopf_driver.GetDescription()}')\n",
    "        \n",
    "        # Get driver metadata\n",
    "        metadata = eopf_driver.GetMetadata()\n",
    "        if metadata:\n",
    "            print(f'   Metadata: {metadata}')\n",
    "        else:\n",
    "            print(f'   No metadata available')\n",
    "            \n",
    "        # Test driver capabilities\n",
    "        print(f'   Can Create: {eopf_driver.GetMetadataItem(\"DCAP_CREATE\") == \"YES\"}')\n",
    "        print(f'   Can CreateCopy: {eopf_driver.GetMetadataItem(\"DCAP_CREATECOPY\") == \"YES\"}')\n",
    "        \n",
    "    else:\n",
    "        print(f'‚ö†Ô∏è EOPF-Zarr driver not found by name')\n",
    "        \n",
    "        # Search for Zarr-related drivers\n",
    "        print(f'üîç Searching for Zarr-related drivers...')\n",
    "        zarr_drivers = []\n",
    "        for i in range(gdal.GetDriverCount()):\n",
    "            driver = gdal.GetDriver(i)\n",
    "            desc = driver.GetDescription().lower()\n",
    "            if 'zarr' in desc or 'eopf' in desc:\n",
    "                zarr_drivers.append(driver.GetDescription())\n",
    "        \n",
    "        if zarr_drivers:\n",
    "            print(f'   Found related drivers: {zarr_drivers}')\n",
    "        else:\n",
    "            print(f'   No Zarr-related drivers found')\n",
    "            \n",
    "        # List first 20 drivers for debugging\n",
    "        print(f'\\nüìã Available drivers (first 20):')\n",
    "        for i in range(min(20, gdal.GetDriverCount())):\n",
    "            driver = gdal.GetDriver(i)\n",
    "            print(f'  {i+1:2d}: {driver.GetDescription()}')\n",
    "        \n",
    "        if gdal.GetDriverCount() > 20:\n",
    "            print(f'  ... and {gdal.GetDriverCount() - 20} more drivers')\n",
    "            \n",
    "except Exception as e:\n",
    "    print(f'‚ùå Error testing EOPF-Zarr driver: {e}')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Test other essential packages\n",
    "packages_to_test = [\n",
    "    'numpy', 'xarray', 'zarr', 'matplotlib', \n",
    "    'rasterio', 'geopandas'\n",
    "]\n",
    "\n",
    "print('üì¶ Testing other packages:')\n",
    "for pkg in packages_to_test:\n",
    "    try:\n",
    "        module = __import__(pkg)\n",
    "        version = getattr(module, '__version__', 'unknown')\n",
    "        print(f'  ‚úÖ {pkg}: {version}')\n",
    "    except ImportError:\n",
    "        print(f'  ‚ùå {pkg}: not available')\n",
    "    except Exception as e:\n",
    "        print(f'  ‚ö†Ô∏è {pkg}: error - {e}')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Force driver registration with debug output\n",
    "print('üîÑ Attempting manual driver registration...')\n",
    "\n",
    "try:\n",
    "    from osgeo import gdal\n",
    "    \n",
    "    # Enable debug output\n",
    "    gdal.SetConfigOption('CPL_DEBUG', 'ON')\n",
    "    gdal.SetConfigOption('GDAL_DRIVER_PATH', '/home/jovyan/eopf-zarr/drivers')\n",
    "    \n",
    "    # Force re-registration\n",
    "    gdal.AllRegister()\n",
    "    \n",
    "    print(f'üìä Drivers after forced registration: {gdal.GetDriverCount()}')\n",
    "    \n",
    "    # Try again to find EOPF driver\n",
    "    eopf_driver = gdal.GetDriverByName('EOPFZARR')\n",
    "    if eopf_driver:\n",
    "        print(f'üéâ EOPF-Zarr driver found after forced registration!')\n",
    "    else:\n",
    "        print(f'‚ö†Ô∏è EOPF-Zarr driver still not found')\n",
    "    \n",
    "    # Disable debug output\n",
    "    gdal.SetConfigOption('CPL_DEBUG', 'OFF')\n",
    "    \n",
    "except Exception as e:\n",
    "    print(f'‚ùå Error during forced registration: {e}')"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {"display_name": "Python 3", "language": "python", "name": "python3"},
  "language_info": {"name": "python", "version": "3.9.0"}
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
EOF

echo "‚úÖ MyBinder EOPF-Zarr setup complete!"
echo "üìù Test notebook created: /home/jovyan/test_eopf_driver.ipynb"
echo "üéØ To test: Open the notebook and run all cells"
